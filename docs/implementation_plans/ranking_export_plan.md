# 順位変動レポートのエクスポート機能 (Excel/PDF) 実装計画

## 1. 概要とコンセプト
ユーザーは、SEO順位の推移を**グラフ付き**でExcelやPDFとして出力・共有したいと考えています。
現在の画面に表示されている `recharts` のグラフをそのまま活用し、クライアントサイドで画像を生成してドキュメントに埋め込むアプローチを採用します。

### コンセプト
- **「見たまま」をレポートに**: 画面で見ているグラフをそのままドキュメント化します。
- **ワンクリック・エクスポート**: サイト詳細画面に「レポート出力」ボタンを配置し、形式（PDF / Excel）を選択できるようにします。
- **ハイブリッドなデータ提供**:
    - **PDF**: 印刷や顧客提出用にレイアウトされた「レポート形式」（グラフ ＋ 順位表）。
    - **Excel**: データ分析用の「生データ」＋ 参照用の「グラフ画像」。

## 2. ユーザーインターフェース (UI/UX)
### 配置場所
`RankingChart` コンポーネントのヘッダー部分（「順位の推移」タイトルの横）、または `SiteHeader` のアクションエリアに「エクスポート」ドロップダウンメニューを追加します。

### 操作フロー
1. ユーザーが「エクスポート」ボタンをクリック。
2. ドロップダウンから「PDF形式 (.pdf)」または「Excel形式 (.xlsx)」を選択。
3. （必要に応じて期間指定などのモーダルを表示するが、今回はシンプルに「現在表示されているデータ」を出力する設計とする）。
4. ファイル生成・ダウンロードが開始される。

## 3. 技術的アプローチ

### 共通: グラフの画像化
サーバーサイドでのグラフ生成は複雑（ヘッドレスブラウザ等が必要）なため、**クライアントサイドでレンダリング済みのDOM要素を画像化**する手法をとります。
- **ライブラリ**: `html2canvas`
- **処理**: `recharts` が描画されている `div` 要素をキャンバス化し、PNG画像データ（Base64）として取得します。

### A. PDF出力
- **ライブラリ**: `jspdf`, `html2canvas`
- **アプローチ**:
    - **日本語対応**: `jspdf` 標準では日本語が文字化けするため、**レポート全体（グラフとデータ表）をクライアントサイドで画像化**し、それをPDFに貼り付ける方式を採用します。これにより、フォント埋め込みの複雑さを回避しつつ、「見たまま」の綺麗なレポート確実に出力します。
- **構成**:
    - 1ページ目: サイト情報、日付、順位推移グラフ（画像）、詳細データテーブル（画像）。

### B. Excel出力
- **ライブラリ**: `exceljs`
- **構成**:
    - **データシートのみ**: 画像は含めず、日付を行、キーワードを列としたマトリクス形式の純粋な数値データのみを出力します。ユーザーが二次加工しやすい形式とします。

## 4. 必要な主要パッケージ
以下のnpmパッケージを追加インストールします。

```bash
npm install html2canvas jspdf jspdf-autotable exceljs file-saver
```
- `html2canvas`: DOMの画像化
- `jspdf`: PDF生成
- `jspdf-autotable`: PDF内でのテーブル描画
- `exceljs`: Excel生成（画像埋め込み対応）
- `file-saver`: 生成したバイナリデータのダウンロード保存

## 5. 実装ステップ

### Step 1: 依存ライブラリのインストール
必要なパッケージをプロジェクトに追加します。

### Step 2: エクスポート用ユーティリティ関数の作成
`lib/export-utils.ts` (仮) を作成し、以下のロジックを実装します。
1. `generateChartImage(elementId: string): Promise<string>`: 指定IDのDOMを画像データURLに変換。
2. `generatePDFReport(siteName: string, chartImage: string, data: any[])`: PDF生成ロジック。
3. `generateExcelReport(siteName: string, chartImage: string, data: any[])`: Excel生成ロジック。

### Step 3: UIへの組み込み
`components/site-detail/RankingChart.tsx` (または親コンポーネント) を修正します。
1. グラフを囲む親要素に一意の `id` を付与（画像化のターゲット用）。
2. ヘッダー部に「エクスポート」ドロップダウンボタンを追加。
3. ボタンクリック時のハンドラを実装（ユーティリティ関数の呼び出し）。

## 6. 懸念点と対応
- **画像化の解像度**: `html2canvas` はデフォルトだと解像度が低くなることがあるため、`scale` オプションで調整する（例: scale 2）。
- **フォント**: 日本語フォントがPDFで文字化けする可能性があります。`jspdf` で日本語を使用するには、日本語フォント（.ttf）をBase64化して埋め込むカスタム設定が必要です。
    - **対応策**: NotoSansJPなどのフリーフォントの軽量版をアセットに含めるか、標準フォントで文字化けしない範囲の文字を使う（あるいは画像化してしまう）。今回は**グラフ全体と表も含めて画像化**してPDFに貼る簡易策も検討可能ですが、テキスト選択できるようにフォント埋め込みがベターです。
